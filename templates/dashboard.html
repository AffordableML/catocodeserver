{% extends "layout.html" %}
{% block title %}Dashboard - CatoCode{% endblock %}

{% block content %}
<div class="min-h-full bg-gray-50 py-10 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">

        <!-- Top Header & Stats -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-10 gap-6">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900 tracking-tight">Dashboard</h1>
                <p class="text-sm text-gray-500 mt-1">Welcome back, {{ current_user.username }}.</p>
            </div>

            <div
                class="bg-white px-5 py-3 rounded-xl shadow-sm border border-gray-200 flex items-center gap-4 w-full md:w-auto">
                <div class="flex-1 text-right md:text-left">
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide">Storage</p>
                    <p class="text-sm font-bold text-gray-700">
                        {{ "%.1f"|format(current_user.storage_used / 1024 / 1024) }} / 50 MB
                    </p>
                </div>
                <div class="w-full md:w-32 h-2 bg-gray-100 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-blue-400 to-purple-500"
                        style="width: {{ storage_percent }}%"></div>
                </div>
            </div>
        </div>

        <!-- ACTION BAR -->
        <div
            class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm mb-8 flex flex-col sm:flex-row items-center justify-between gap-4">
            <h2 class="text-lg font-bold text-gray-700 flex items-center gap-2">
                <i class="fas fa-folder-open text-gray-400"></i> Your Projects
            </h2>
            <div class="flex gap-3 w-full sm:w-auto">
                <button onclick="openCreateModal('code')"
                    class="flex-1 sm:flex-none px-5 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-code text-blue-500"></i> New Website
                </button>
                <button onclick="openCreateModal('game')"
                    class="flex-1 sm:flex-none px-5 py-2.5 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg font-bold hover:from-purple-700 hover:to-indigo-700 transition shadow-md hover:shadow-lg flex items-center justify-center gap-2 transform hover:-translate-y-0.5">
                    <i class="fas fa-gamepad"></i> Create Game
                </button>
            </div>
        </div>

        <!-- Projects Grid -->
        {% if projects %}
        <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
            {% for project in projects %}
            <div
                class="group bg-white overflow-hidden shadow-sm rounded-xl border border-gray-200 hover:shadow-xl hover:border-primary/30 transition-all duration-300 flex flex-col relative">
                <!-- Project Type Badge -->
                <div class="absolute top-4 right-4 z-10">
                    {% if project.type == 'game' %}
                    <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-purple-100 text-purple-700 border border-purple-200 shadow-sm">
                        <i class="fas fa-gamepad mr-1"></i> GAME
                    </span>
                    {% else %}
                    <span
                        class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-blue-50 text-blue-600 border border-blue-100 shadow-sm">
                        <i class="fas fa-code mr-1"></i> WEB
                    </span>
                    {% endif %}
                </div>

                <div class="px-6 py-6 flex-1">
                    <h3 class="text-xl font-bold text-gray-900 truncate pr-16 mb-1 group-hover:text-primary transition-colors"
                        title="{{ project.name }}">
                        {{ project.name }}
                    </h3>
                    <p class="text-xs text-gray-400 mb-4 flex items-center gap-1">
                        <i class="far fa-clock"></i> Updated {{ project.updated_at.split(' ')[0] }}
                        {% if project.visibility == 'public' %}
                        <span
                            class="ml-2 text-green-600 bg-green-50 px-1.5 rounded text-[10px] font-bold border border-green-100">PUBLIC</span>
                        {% endif %}
                    </p>

                    <p class="text-sm text-gray-500 line-clamp-2 min-h-[2.5rem]">
                        {{ project.description or "No description provided." }}
                    </p>

                    <div class="mt-4 flex items-center space-x-4 text-sm text-gray-400 border-t border-gray-50 pt-3">
                        <div class="flex items-center" title="Likes"><i class="fas fa-heart mr-1.5 text-red-400"></i> {{
                            project.likes_count }}</div>
                        <div class="flex items-center" title="Remixes"><i
                                class="fas fa-code-branch mr-1.5 text-blue-400"></i> {{ project.remix_count }}</div>
                    </div>
                </div>

                <div
                    class="bg-gray-50 px-6 py-4 border-t border-gray-100 flex justify-between items-center group-hover:bg-white transition-colors">
                    <div class="flex space-x-3">
                        <a href="{{ url_for('editor_existing', project_id=project.id) }}"
                            class="text-gray-600 hover:text-primary font-bold text-sm transition flex items-center gap-1">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <a href="{{ url_for('project_admin', project_id=project.id) }}"
                            class="text-gray-600 hover:text-primary font-bold text-sm transition flex items-center gap-1">
                            <i class="fas fa-database"></i> DB
                        </a>
                        <span class="text-gray-300">|</span>
                        <a href="{{ url_for('project_public', project_uid=project.project_uid) }}" target="_blank"
                            class="text-gray-600 hover:text-primary font-bold text-sm transition flex items-center gap-1">
                            <i class="fas fa-play-circle"></i> Play
                        </a>
                    </div>
                    <form action="{{ url_for('delete_project', project_id=project.id) }}" method="post"
                        onsubmit="return confirm('Are you sure? This cannot be undone.');">
                        <button type="submit"
                            class="text-gray-400 hover:text-red-600 transition p-1 rounded hover:bg-red-50"
                            title="Delete Project">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <!-- Empty State -->
        <div class="text-center py-24 bg-white rounded-2xl border-2 border-dashed border-gray-300">
            <div class="mx-auto h-20 w-20 bg-gray-50 rounded-full flex items-center justify-center text-gray-300 mb-4">
                <i class="fas fa-layer-group text-4xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900">No projects yet</h3>
            <p class="mt-1 text-sm text-gray-500 max-w-sm mx-auto mb-8">Get started by building a website or creating
                your own platformer game.</p>
            <div class="flex justify-center gap-4">
                <button onclick="openCreateModal('code')"
                    class="px-6 py-3 bg-white border border-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-50 transition shadow-sm">
                    New Website
                </button>
                <button onclick="openCreateModal('game')"
                    class="px-6 py-3 bg-primary text-white rounded-lg font-bold hover:bg-blue-600 transition shadow-lg shadow-blue-200">
                    <i class="fas fa-gamepad mr-2"></i> Create Game
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Smart Create Project Modal -->
<div id="create-modal"
    class="fixed inset-0 bg-black/60 hidden place-items-center z-50 backdrop-blur-sm transition-all opacity-0 pointer-events-none">
    <div
        class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform scale-95 transition-all duration-200 p-8 relative">
        <button onclick="closeCreateModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i
                class="fas fa-times text-xl"></i></button>

        <h2 class="text-2xl font-bold text-gray-900 mb-2" id="modal-title">Create New Project</h2>
        <p class="text-gray-500 mb-6 text-sm">Choose a template to get started.</p>

        <div class="mb-6">
            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Project Name</label>
            <input type="text" id="new-project-name"
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none text-lg"
                placeholder="My Awesome Project">
        </div>

        <!-- Template Selection -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8" id="template-grid">
            <!-- Game Template (Shown for Game Mode) -->
            <button onclick="selectTemplate(this, 'game')" id="temp-game"
                class="template-card group p-4 rounded-xl border-2 border-purple-100 bg-purple-50 text-left hover:border-purple-500 transition relative overflow-hidden">
                <div class="absolute top-0 right-0 bg-purple-500 text-white text-[10px] font-bold px-2 py-1 rounded-bl">
                    CATO2D ENGINE</div>
                <div
                    class="w-12 h-12 bg-white rounded-lg flex items-center justify-center text-purple-600 mb-3 shadow-sm group-hover:scale-110 transition">
                    <i class="fas fa-gamepad text-2xl"></i>
                </div>
                <h3 class="font-bold text-gray-900">Platformer Game</h3>
                <p class="text-xs text-gray-600 mt-1">No-code level builder with physics.</p>
            </button>

            <!-- Code Templates (Shown for Code Mode) -->
            <button onclick="selectTemplate(this, 'blank')" id="temp-blank"
                class="template-card p-4 rounded-xl border border-gray-200 text-left hover:border-primary hover:bg-blue-50 transition">
                <div class="w-10 h-10 bg-gray-100 rounded-lg flex items-center justify-center text-gray-600 mb-3"><i
                        class="fas fa-file-code"></i></div>
                <h3 class="font-bold text-gray-900">Blank Website</h3>
                <p class="text-xs text-gray-500 mt-1">Empty canvas + serverless.</p>
            </button>
            <button onclick="selectTemplate(this, 'landing')" id="temp-landing"
                class="template-card p-4 rounded-xl border border-gray-200 text-left hover:border-primary hover:bg-blue-50 transition">
                <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center text-indigo-600 mb-3"><i
                        class="fas fa-laptop-code"></i></div>
                <h3 class="font-bold text-gray-900">Landing Page</h3>
                <p class="text-xs text-gray-500 mt-1">Responsive starter kit.</p>
            </button>
            <button onclick="selectTemplate(this, 'chat')" id="temp-chat"
                class="template-card p-4 rounded-xl border border-gray-200 text-left hover:border-primary hover:bg-blue-50 transition">
                <div class="w-10 h-10 bg-yellow-100 rounded-lg flex items-center justify-center text-yellow-600 mb-3"><i
                        class="fas fa-comments"></i></div>
                <h3 class="font-bold text-gray-900">Global Chat</h3>
                <p class="text-xs text-gray-500 mt-1">Python DB example.</p>
            </button>
        </div>

        <div class="flex justify-end gap-3 pt-4 border-t border-gray-100">
            <button onclick="closeCreateModal()"
                class="px-6 py-2.5 text-gray-600 hover:bg-gray-100 rounded-lg font-bold transition">Cancel</button>
            <button onclick="submitCreate()"
                class="px-8 py-2.5 bg-primary text-white rounded-lg font-bold hover:bg-blue-600 transition shadow-lg shadow-blue-500/30 flex items-center">
                <i class="fas fa-magic mr-2"></i> Create
            </button>
        </div>
    </div>
</div>

<script>
    let selectedTemplate = 'blank';

    function openCreateModal(type) {
        const modal = document.getElementById('create-modal');
        const title = document.getElementById('modal-title');
        const nameInput = document.getElementById('new-project-name');

        // UI Reset
        modal.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
        modal.querySelector('div').classList.remove('scale-95');
        modal.querySelector('div').classList.add('scale-100');

        // Filter templates based on type
        const gameTemp = document.getElementById('temp-game');
        const codeTemps = [document.getElementById('temp-blank'), document.getElementById('temp-landing'), document.getElementById('temp-chat')];

        if (type === 'game') {
            title.innerText = "Create New Game";
            nameInput.placeholder = "Super Mario Clone";
            // Show only game, auto select
            gameTemp.style.display = 'block';
            codeTemps.forEach(el => el.style.display = 'none');
            selectTemplate(gameTemp, 'game');
        } else {
            title.innerText = "Create New Website";
            nameInput.placeholder = "My Portfolio";
            // Show only code
            gameTemp.style.display = 'none';
            codeTemps.forEach(el => el.style.display = 'block');
            selectTemplate(document.getElementById('temp-blank'), 'blank');
        }

        nameInput.focus();
    }

    function closeCreateModal() {
        const modal = document.getElementById('create-modal');
        modal.classList.add('opacity-0', 'pointer-events-none');
        modal.querySelector('div').classList.remove('scale-100');
        modal.querySelector('div').classList.add('scale-95');
        setTimeout(() => modal.classList.add('hidden'), 200);
    }

    function selectTemplate(el, id) {
        selectedTemplate = id;
        document.querySelectorAll('.template-card').forEach(c => {
            c.classList.remove('ring-4', 'ring-primary', 'bg-blue-50', 'border-transparent');
            // Reset borders
            if (c.id === 'temp-game') c.classList.add('border-purple-100');
            else c.classList.add('border-gray-200');
        });

        el.classList.remove('border-gray-200', 'border-purple-100');
        el.classList.add('ring-4', 'ring-primary', 'border-transparent');
    }

    async function submitCreate() {
        const name = document.getElementById('new-project-name').value || (selectedTemplate === 'game' ? 'My Game' : 'My Website');

        try {
            const res = await fetch('/project/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, template: selectedTemplate })
            });
            const data = await res.json();
            if (data.success) {
                window.location.href = `/editor/${data.project_id}`;
            } else {
                alert('Error creating project: ' + data.error);
            }
        } catch (e) {
            console.error(e);
            alert('Request failed');
        }
    }
</script>
{% endblock %}