<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>CatoCode IDE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        #editor {
            font-family: 'JetBrains Mono', monospace !important;
        }

        .resizer {
            cursor: col-resize;
            width: 4px;
            transition: 0.2s;
        }

        .resizer:hover {
            background: #3b82f6;
        }
    </style>
</head>

<body class="bg-white text-slate-800 h-screen flex flex-col overflow-hidden">
    <script>
        const PROJECT_DATA = {{ project_data| tojson }};
        // FIXED: Safely inject plugins array
        const ACTIVE_PLUGINS = {{ plugins| tojson | safe }};
    </script>

    <!-- Header -->
    <header class="h-14 border-b px-4 flex items-center justify-between bg-white z-20">
        <div class="flex items-center gap-4">
            <a href="/dashboard" class="text-blue-600 font-black text-xl">CatoCode</a>
            <span class="text-slate-300">/</span>
            <span class="font-bold text-slate-600">{{ project_data.name }}</span>
        </div>
        <div class="flex items-center gap-2">
            <button id="save-btn"
                class="px-4 py-1.5 bg-blue-600 text-white rounded font-bold shadow-lg shadow-blue-500/20">Save</button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-64 bg-slate-50 border-r flex flex-col shrink-0">
            <!-- Tabs -->
            <div class="flex border-b">
                <button class="flex-1 py-2 text-xs font-bold text-blue-600 border-b-2 border-blue-600"
                    id="tab-files">Files</button>
                <button class="flex-1 py-2 text-xs font-bold text-slate-500" id="tab-assets">Assets</button>
            </div>

            <!-- File Tree -->
            <div id="file-tree" class="flex-1 overflow-y-auto p-2"></div>

            <!-- Asset Grid (Hidden by default) -->
            <div id="asset-grid" class="flex-1 overflow-y-auto p-2 hidden grid grid-cols-2 gap-2 content-start"></div>

            <div class="p-2 border-t flex gap-1">
                <button id="new-file"
                    class="flex-1 bg-white border py-1 rounded text-xs font-bold hover:bg-blue-50 transition">+
                    File</button>
                <button id="upload-asset-btn"
                    class="flex-1 bg-white border py-1 rounded text-xs font-bold hover:bg-blue-50 transition">üìÅ
                    Upload</button>
                <input type="file" id="upload-input" hidden multiple
                    accept="image/*,.html,.css,.js,.py,.json,.txt,.svg,.webp,.gif,.mp3,.wav,.mp4">
            </div>
        </aside>

        <div class="resizer" id="resizer-left"></div>

        <!-- Editor -->
        <div class="flex-1 flex flex-col min-w-0 bg-white relative">
            <div id="editor" class="flex-1"></div>
        </div>

        <div class="resizer" id="resizer-right"></div>

        <!-- Preview -->
        <aside id="preview-pane" class="w-1/3 border-l flex flex-col shrink-0">
            <div class="h-10 bg-slate-50 border-b flex items-center justify-between px-2">
                <span class="font-bold text-xs text-slate-500 uppercase tracking-wide">Preview</span>
                <button id="refresh" class="text-slate-400 hover:text-blue-600"><i class="fas fa-rotate"></i></button>
            </div>
            <div class="flex-1 bg-white relative">
                <iframe id="preview-frame" class="w-full h-full border-none"></iframe>
            </div>
        </aside>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
    <script src="{{ url_for('static', filename='js/editor.js') }}"></script>
    <script>
        // Apply Plugins Safely
        if (Array.isArray(ACTIVE_PLUGINS)) {
            ACTIVE_PLUGINS.forEach(code => {
                try {
                    // Wrap in IIFE to prevent scope pollution
                    (function () { eval(code); })();
                } catch (e) { console.error("Plugin Error:", e); }
            });
        }
    </script>
</body>

</html>