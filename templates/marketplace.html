{% extends "layout.html" %}
{% block title %}Plugin Marketplace - CatoCode{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-slate-50 to-white">
    <!-- Header -->
    <div class="bg-white border-b sticky top-0 z-20">
        <div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-black text-slate-800">Plugin Marketplace</h1>
                <p class="text-slate-500 text-sm">Discover and install community plugins</p>
            </div>
            <div class="flex items-center gap-4">
                <a href="/sdk" class="text-blue-600 font-bold hover:underline">
                    <i class="fas fa-book mr-1"></i> SDK Docs
                </a>
                {% if current_user.is_authenticated %}
                <a href="/dashboard/plugins"
                    class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700">
                    My Plugins
                </a>
                {% else %}
                <a href="/login" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700">
                    Sign In
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Search & Filters -->
    <div class="max-w-7xl mx-auto px-6 py-6">
        <div class="flex flex-wrap gap-4 items-center justify-between">
            <div class="relative flex-1 max-w-md">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                <input type="text" id="search-input" placeholder="Search plugins..."
                    class="w-full pl-12 pr-4 py-3 border rounded-xl bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
            </div>
            <div class="flex gap-2">
                <button class="category-btn active px-4 py-2 rounded-lg font-bold text-sm"
                    data-category="all">All</button>
                <button class="category-btn px-4 py-2 rounded-lg font-bold text-sm"
                    data-category="utility">Utility</button>
                <button class="category-btn px-4 py-2 rounded-lg font-bold text-sm"
                    data-category="editor">Editor</button>
                <button class="category-btn px-4 py-2 rounded-lg font-bold text-sm" data-category="theme">Theme</button>
            </div>
        </div>
    </div>

    <!-- Plugin Grid -->
    <div class="max-w-7xl mx-auto px-6 pb-20">
        <!-- Community Plugins Header -->
        <div class="flex items-center gap-3 mb-6">
            <span class="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-bold rounded-full uppercase tracking-wide">
                <i class="fas fa-users mr-1"></i> Community
            </span>
            <h2 class="text-xl font-bold text-slate-800">Community Plugins</h2>
        </div>

        <div id="plugin-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for p in plugins %}
            <div class="plugin-card bg-white rounded-2xl border shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden group"
                data-name="{{ p.name|lower }}" data-category="{{ p.category or 'utility' }}" data-id="{{ p.id }}">
                <!-- Image -->
                <div
                    class="h-40 bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center relative overflow-hidden">
                    {% if p.image_url %}
                    <img src="{{ p.image_url }}" class="w-full h-full object-cover" alt="{{ p.name }}">
                    {% else %}
                    <i class="fas fa-puzzle-piece text-white/30 text-6xl"></i>
                    {% endif %}
                    <div
                        class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-4">
                        <button onclick="viewSource({{ p.id }})"
                            class="px-4 py-2 bg-white/20 text-white rounded-lg font-bold hover:bg-white/30 transition">
                            <i class="fas fa-code mr-1"></i> Source
                        </button>
                        {% if current_user.is_authenticated %}
                        <button onclick="installPlugin({{ p.id }})"
                            class="px-4 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition">
                            <i class="fas fa-download mr-1"></i> Install
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Content -->
                <div class="p-5">
                    <div class="flex items-start justify-between mb-2">
                        <h3 class="font-bold text-lg text-slate-800">{{ p.name }}</h3>
                        <span class="text-xs px-2 py-1 bg-slate-100 text-slate-500 rounded-full">{{ p.category or
                            'utility' }}</span>
                    </div>
                    <p class="text-slate-500 text-sm mb-4 line-clamp-2">{{ p.description or 'No description provided.'
                        }}</p>
                    <div class="flex items-center justify-between text-xs text-slate-400">
                        <span><i class="fas fa-user mr-1"></i> {{ p.author }}</span>
                        <span><i class="fas fa-download mr-1"></i> {{ p.install_count or 0 }} installs</span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-span-full text-center py-20 text-slate-400">
                <i class="fas fa-puzzle-piece text-6xl mb-4 opacity-30"></i>
                <p class="text-xl font-bold">No community plugins yet</p>
                <p class="text-sm">Be the first to share a plugin!</p>
            </div>
            {% endfor %}
        </div>

        <!-- Community Templates Section -->
        <div class="flex items-center gap-3 mb-6 mt-12">
            <span class="px-3 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-full uppercase tracking-wide">
                <i class="fas fa-code mr-1"></i> Templates
            </span>
            <h2 class="text-xl font-bold text-slate-800">Community Templates</h2>
        </div>

        <div id="template-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for t in templates %}
            <div
                class="template-card bg-white rounded-2xl border shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden group">
                <!-- Preview -->
                <div
                    class="h-40 bg-gradient-to-br from-green-500 to-teal-600 flex items-center justify-center relative overflow-hidden">
                    <i class="fas fa-file-code text-white/30 text-6xl"></i>
                    <div
                        class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-3">
                        <button onclick="viewTemplateSource('{{ t.uid }}')"
                            class="px-3 py-2 bg-white/20 text-white rounded-lg font-bold hover:bg-white/30 transition text-sm">
                            <i class="fas fa-code mr-1"></i> Source
                        </button>
                        {% if current_user.is_authenticated %}
                        <button onclick="remixTemplate('{{ t.uid }}')"
                            class="px-3 py-2 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 transition text-sm">
                            <i class="fas fa-code-branch mr-1"></i> Remix
                        </button>
                        {% endif %}
                    </div>
                </div>
                <div class="p-5">
                    <h3 class="font-bold text-lg text-slate-800 mb-2">{{ t.name }}</h3>
                    <p class="text-slate-500 text-sm mb-4">{{ t.description or 'A community template' }}</p>
                    <div class="flex items-center justify-between text-xs text-slate-400">
                        <span><i class="fas fa-user mr-1"></i> {{ t.author }}</span>
                        <span><i class="fas fa-code-branch mr-1"></i> {{ t.remix_count or 0 }} remixes</span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="col-span-full text-center py-20 text-slate-400">
                <i class="fas fa-file-code text-6xl mb-4 opacity-30"></i>
                <p class="text-xl font-bold">No community templates yet</p>
                <p class="text-sm">Share your project as a template from the dashboard!</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Source Modal -->
<div id="source-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4"
    onclick="if(event.target===this) closeModal()">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl max-h-[80vh] overflow-hidden flex flex-col">
        <div class="p-4 border-b flex items-center justify-between">
            <h3 id="modal-title" class="font-bold text-xl">Plugin Source</h3>
            <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600"><i
                    class="fas fa-times text-xl"></i></button>
        </div>
        <div class="p-4 border-b bg-slate-50">
            <p id="modal-description" class="text-slate-600 text-sm"></p>
        </div>
        <div class="flex-1 overflow-auto p-4 bg-slate-900">
            <pre id="modal-code" class="text-sm text-green-400 font-mono whitespace-pre-wrap"></pre>
        </div>
    </div>
</div>

<style>
    .category-btn {
        background: white;
        border: 1px solid #e2e8f0;
        color: #64748b;
        transition: all 0.2s;
    }

    .category-btn:hover,
    .category-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<script>
    // Search
    document.getElementById('search-input').addEventListener('input', filterPlugins);

    // Category filter
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            filterPlugins();
        };
    });

    function filterPlugins() {
        const search = document.getElementById('search-input').value.toLowerCase();
        const category = document.querySelector('.category-btn.active').dataset.category;

        document.querySelectorAll('.plugin-card').forEach(card => {
            const name = card.dataset.name;
            const cat = card.dataset.category;
            const matchesSearch = name.includes(search);
            const matchesCategory = category === 'all' || cat === category;
            card.style.display = matchesSearch && matchesCategory ? 'block' : 'none';
        });
    }

    async function viewSource(id) {
        const res = await fetch('/api/plugin/' + id + '/source');
        const data = await res.json();
        document.getElementById('modal-title').textContent = data.name;
        document.getElementById('modal-description').textContent = data.description || 'No description';
        document.getElementById('modal-code').textContent = data.code;
        document.getElementById('source-modal').classList.remove('hidden');
        document.getElementById('source-modal').classList.add('flex');
    }

    function closeModal() {
        document.getElementById('source-modal').classList.add('hidden');
        document.getElementById('source-modal').classList.remove('flex');
    }

    async function installPlugin(id) {
        const res = await fetch('/api/plugin/' + id + '/install', { method: 'POST' });
        const data = await res.json();
        if (data.success) {
            alert('Plugin installed! Go to Dashboard > Plugins to activate it.');
        } else {
            alert(data.error || 'Failed to install');
        }
    }

    // Template Functions
    async function viewTemplateSource(uid) {
        const res = await fetch('/api/template/' + uid + '/source');
        const data = await res.json();
        document.getElementById('modal-title').textContent = data.name + ' (Template)';
        document.getElementById('modal-description').textContent = data.description || 'Community template';
        document.getElementById('modal-code').textContent = data.files.map(f =>
            '// === ' + f.name + ' ===\n' + f.content
        ).join('\n\n');
        document.getElementById('source-modal').classList.remove('hidden');
        document.getElementById('source-modal').classList.add('flex');
    }

    async function remixTemplate(uid) {
        const name = prompt('Name your new project:', 'My Remix');
        if (!name) return;
        const res = await fetch('/api/template/' + uid + '/remix', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        const data = await res.json();
        if (data.success) {
            window.location.href = '/editor/' + data.project_id;
        } else {
            alert(data.error || 'Failed to remix');
        }
    }
</script>
{% endblock %}